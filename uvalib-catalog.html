<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../uvalib-api/uvalib-api.html">

<!--
Element providing an easy component access to the uva library's catalog.

##### Example

    <uvalib-catalog></uvalib-catalog>

@element uvalib-catalog
@blurb Element providing an easy component access to the uva library's catalog.
@status alpha
@homepage http://uvalib-components.github.io/uvalib-catalog
-->
<polymer-element name="uvalib-catalog" attributes="auto append count facets items availability directions page per_page query sort_order operator author title_query journal_title subject keywords call_number publisher year_published_start year_published_end facet_limits facet_limits_json facet_limits_inc facet_limits_inc_json more">
  <template>
    <uvalib-api on-uvalib-api-load="{{apiLoaded}}"></uvalib-api>
  </template>
  <script>
    Polymer({

      observe: {
        auto: function(){this.fetch(false);},
        availability: function(){this.fetch(false);},
        directions: function(){this.fetch(false);},
        page: function(){this.fetch(true);},
        per_page: function(){this.fetch(false);},
        query: function(){this.fetch(false);},
        sort_order: function(){this.fetch(false);},
        operator: function(){this.fetch(false);},
        author: function(){this.fetch(false);},
        title_query: function(){this.fetch(false);},
        journal_title: function(){this.fetch(false);},
        subject: function(){this.fetch(false);},
        keywords: function(){this.fetch(false);},
        call_number: function(){this.fetch(false);},
        publisher: function(){this.fetch(false);},
        year_published_start: function(){this.fetch(false);},
        year_published_end: function(){this.fetch(false);}
      },

      /**
       * The `auto` attribute set to true means that the catalog will be queried 
       * whenever a request attribute is changed.
       *
       * @attribute auto
       * @type bool
       * @default false
       */
      auto: false,

      /**
       * The `append` attribute set to true means that the items returned from a search will append the current list of items
       *
       * @attribute append
       * @type bool
       * @default false
       */
      append: false,

      /**
       * The `count` attribute is set to the total query result count from the 
       * catalog once a request has been fetched
       *
       * @attribute count
       * @type string
       * @default null
       */
      count: null,

      /**
       * The `more` attribute is set to true is there are more results to retrieve by incrementing the page count
       *
       * @attribute more
       * @type boolean
       * @default null
       */
      more: null,

      /**
       * The `facets` attribute is set with the facets in a catalog response
       *
       * @attribute facets
       * @type object
       * @default null
       */
      facets: null,

      /**
       * The `items` attribute is set with the results for a catalog request
       *
       * @attribute items
       * @type array
       * @default null
       */
      items: null,

      /**
       * The `availability` attribute specifies wheather the results should include availability info (at the cost of a slower response)
       *
       * @attribute availability
       * @type boolean
       * @default false
       */ 
      availability: false, 

      /**
       * The `directions` attribute specifies wheather the results should include directions info
       *
       * @attribute directions
       * @type boolean
       * @default false
       */ 
      directions: false, 


      /**
       * The `page` attribute specifies the page of results to return from the catalog search
       *
       * @attribute page
       * @type integer
       * @default 1
       */ 
      page: 1, 

      /**
       * The `per_page` attribute limits the number of results returned in the catalog search result
       *
       * @attribute per_page
       * @type integer
       * @default 10
       */      
      per_page: 10,

      /**
       * The `query` attribute sets the general query of the catalog search request
       *
       * @attribute query
       * @type string
       * @default ""
       */
      query: "",

      /**
       * The `sort_order` attribute sets the sort order of the catalog search results.
       * Values can be one of "author", "published", "published_a", "received", "relevancy", or "title"
       *
       * @attribute sort_order
       * @type string
       * @default "relevancy"
       */
      sort_order: "relevancy",

      /**
       * The `operator` attribute sets the operator used for the advanced fields.  Options are 'AND' and 'OR'.
       *
       * @attribute query
       * @type string
       * @default "AND"
       */
      operator:'AND',

      /**
       * The `author` attribute sets the advanced query for author
       *
       * @attribute author
       * @type string
       * @default ""
       */
      author:'',

      /**
       * The `title` attribute sets the advanced query for title
       *
       * @attribute title
       * @type string
       * @default ""
       */
      title_query:'',

      /**
       * The `journal_title` attribute sets the advanced query for journal_title
       *
       * @attribute journal_title
       * @type string
       * @default ""
       */
      journal_title:'',

      /**
       * The `subject` attribute sets the advanced query for subject
       *
       * @attribute subject
       * @type string
       * @default ""
       */
      subject:'',

      /**
       * The `keywords` attribute sets the advanced query for keywords
       *
       * @attribute keywords
       * @type string
       * @default ""
       */
      keywords:'',

      /**
       * The `call_number` attribute sets the advanced query for call_number
       *
       * @attribute call_number
       * @type string
       * @default ""
       */
      call_number:'',

      /**
       * The `publisher` attribute sets the advanced query for publisher
       *
       * @attribute publisher
       * @type string
       * @default ""
       */
      publisher:'',

      /**
       * The `year_published_start` attribute sets the advanced query for year_published_start
       *
       * @attribute year_published_start
       * @type string
       * @default ""
       */
      year_published_start:'',

      /**
       * The `year_published_end` attribute sets the advanced query for year_published_end
       *
       * @attribute year_published_end
       * @type string
       * @default ""
       */
      year_published_end:'',

      /**
       * The `facet_limits` attribute limits the results to those matching the facets (ex: {"library":"Alderman"} or {"library":["Alderman","Law Library"]})
       *
       * @attribute facet_limits
       * @type object
       * @default null
       */
      facet_limits:null,

      /**
       * The `facet_limits_json` attribute is a mirror of (and bound to) the facet_limits attribute.  The only difference is that this attribute is in json format (string)
       *
       * @attribute facet_limits_json
       * @type string
       * @default null
       */
      facet_limits_json:null,

      /**
       * The `facet_limits_inc` attribute limits the results to those matching the facets inclusivly (ex: {"library":"Alderman"} or {"library":["Alderman","Law Library"]})
       *
       * @attribute facet_limits_inc
       * @type object
       * @default null
       */
      facet_limits_inc:null,

      /**
       * The `facet_limits_inc_json` attribute is a mirror of (and bound to) the facet_limits_inc attribute.  The only difference is that this attribute is in json format (string)
       *
       * @attribute facet_limits_inc_json
       * @type string
       * @default null
       */
      facet_limits_inc_json:null,

      /**
       * The `api` property is set to the Library's client catalog api once loaded
       *
       * @attribute api
       * @type object
       * @default null
       */
      api: null,

      apiLoaded: function (e) {
        this.api = e.detail.catalog;
        this.facet_limitsChanged();
        this.facet_limits_incChanged();
        if (this.auto)
          this.fetch();
      },

      facet_limitsChanged: function() {
        var fl = JSON.stringify(this.facet_limits);
        if (fl != this.facet_limits_json)
          this.facet_limits_json = fl;
      },

      facet_limits_incChanged: function() {
        var fl = JSON.stringify(this.facet_limits_inc);
        if (fl != this.facet_limits_inc_json)
          this.facet_limits_inc_json = fl;
      },

      facet_limits_jsonChanged: function() {
        if (JSON.stringify(this.facet_limits) != this.facet_limits_json) {
          this.facet_limits = JSON.parse(this.facet_limits_json);
        }
        this.fetch();
      },

      facet_limits_inc_jsonChanged: function() {
        if (JSON.stringify(this.facet_limits_inc) != this.facet_limits_inc_json) {
          this.facet_limits_inc = JSON.parse(this.facet_limits_inc_json);
        }
        this.fetch();
      },

      // Keep track of requests so that older ones can be ignored
      // ToDo: see if we can cancel api requests before they return
      requests:[],

      /**
       * The `fetch` method will make a query request against the catalog.
       *
       * @method fetch
       * @param {Boolean} append If true new items are appended to previously returned items.
       */
      fetch: function (soft){

        this.job('fetch', function(){

        if (this.api) {

          // Cancel all requests currently running
          for (var i=0; i<this.requests.length; i++)
            this.requests[i].cancel=true;

          var req_pack = {
            availability: this.availability,
            page: this.page,
            per_page: this['per_page'],
            query: this.query,
            sort_order: this['sort_order'],
            operator: this.operator,
            author: this.author,
            title: this['title_query'],
            journal_title: this['journal_title'],
            subject: this.subject,
            keywords: this.keywords,
            call_number: this['call_number'],
            publisher: this.publisher,
            year_published_start: this['year_published_start'],
            year_published_end: this['year_published_end'],
            facets: this.facet_limits_json,
            facets_inclusive: this.facet_limits_inc_json
            };

          // Put a simple message into the requests queue for this request
          var mess = {cancel:false, soft:soft};
          this.requests.push(mess);

          console.log('fetching catalog results!');
          return this.api.search(req_pack).execute( this.parseResults.bind(this, mess) );
        }

        }, 750);
      },

      /**
       * The `uvalib-catalog-fetched-results` event is fired whenever we
       * call fetch and process the results.
       *
       * @event uvalib-catalog-fetched-results
       */
      parseResults: function(mess, results){
        if (!mess.cancel) {
          if (this.append && mess.soft)
            this.items = (this.items == null)? results.items: this.items.concat(results.items);
          else
            this.items = results.items; 
          this.count = results.count;          
          this.facets = results.facets;
          this.more = results.count > this.page*this.per_page;
          this.fire('uvalib-catalog-fetched-results');
        } else {
          console.log('fetch canceled!');
        }

        // remove this requests message from the queue
        for (var i=0; i<this.requests.length; i++)
          if (mess == this.requests[i]) {
            this.requests.splice(i,1);
            break;
          }
      }
      
    });
  </script>
</polymer-element>
