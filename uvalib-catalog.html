<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../uvalib-helper-libs/lodash.html">

<!--
An element used to interface with the UVa Library Catalog API via ajax.

Example:

    <uvalib-catalog auto></uvalib-catalog>

Example:

    <uvalib-catalog></uvalib-catalog>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="uvalib-catalog">
  <template>
    <iron-ajax id="ajax" auto="[[auto]]" debounce-duration="{{debounceDuration}}"
          loading="{{loading}}" params="{{_params}}"
          timeout="{{timeout}}" url="{{_url}}" verbose="{{verbose}}"
          on-error="_handleError" on-request="_handleRequest" on-response="_handleResponse"
          handle-as="json"></iron-ajax>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'uvalib-catalog',

      properties: {

        /**
         * If true, automatically performs an Ajax request when *** Something changes ***
         */
        auto: {
          type: Boolean,
          value: false
        },

        /**
         * Total number of results in the last response ***(not just the returned rows)***
         */
        count: {
          type: Number,
          value: 0,
          notify: true,
          readOnly: true
        },

        /**
         * Length of time in milliseconds to debounce multiple automatically generated requests.
         */
        debounceDuration: {
          type: Number,
          value: 0,
          notify: true
        },

        /**
         * Defines the filters that should be used (from the available filters)
         * and how they should be mapped.  ***This might be renamed to filter-mapping soon***
         */
        filters: {
          type: Array,
          value: function(){
            return [{orig:'library_facet',new:'library',name:'Library'},
                    {orig:'format_facet',new:'format',name:'Format'},
                    {orig:'published_date_facet',new:'era',name:'Publication Era'},
                    {orig:'author_facet',new:'author',name:'Author'},
                    {orig:'subject_facet',new:'subject',name:'Subject'},
                    {orig:'language_facet',new:'language',name:'Language'},
                    {orig:'call_number_facet',new:'call_number',name:'Call Number'},
                    {orig:'region_facet',new:'region',name:'Geographic Location'},
                    {orig:'digital_collection_facet',new:'digital_collection',name:'Digital Collection'},
                    {orig:'source_facet',new:'source',name:'Source'},
                    {orig:'series_title_facet',new:'series',name:'Series'}];
          },
          notify: true
        },

        /**
         * The items from the Catalog request, in a normalized/simplified Format
         *
         * @type {Object[]}
         */
        items: {
          type: Array,
          value: [],
          notify: true,
          readOnly: true
        },

        /**
         * The query string of the search
         */
        query: {
          type: String,
          notify: true,
          value: "",
          observer: "_queryChanged"
        },

        /**
         * Set the timeout flag on the request.
         */
        timeout: {
          type: Number,
          value: 0
        },

        /**
         * If true, error messages will automatically be logged to the console.
         */
        verbose: {
          type: Boolean,
          value: false
        },

        /**
         * True while lastRequest is in flight.
         */
        loading: {
          type: Boolean,
          notify: true,
        },

        /**
         * The base url used to make requests to the catalog. ***This should change when we are no longer using the proxy for CORS support***
         */
        _url: {
          type: String,
          value: "http://api.library.virginia.edu/catalog.json"
        },

        /**
         * The parameters to pass to the catalog api (as GET parameters)
         * See https://confluence.lib.virginia.edu/pages/viewpage.action?pageId=13763696 for api
         */
        _params: {
          type: Object,
          value: {q:''},
          notify: true
        }

      },

      // Element Lifecycle

      ready: function() {
        // `ready` is called after all elements have been configured, but
        // propagates bottom-up. This element's children are ready, but parents
        // are not.
        //
        // This is the point where you should make modifications to the DOM (when
        // necessary), or kick off any processes the element wants to perform.
      },

      attached: function() {
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
      },

      detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
      },

      // Element Behavior

      /**
       * Sometimes it's just nice to say hi.
       *
       * @param {string} greeting A positive greeting.
       * @return {string} The full greeting.
       */
      sayHello: function(greeting) {
        var response = greeting || 'Hello World!';
        return 'uvalib-catalog says, ' + response;
      },

      /**
       * The `uvalib-catalog-lasers` event is fired whenever `fireLasers` is called.
       *
       * @event uvalib-catalog-lasers
       * @detail {{sound: String}}
       */

      /**
       * Attempt to destroy this element's enemies with a beam of light!
       *
       * Or, at least, dispatch an event in the vain hope that someone else will
       * do the zapping.
       */
      fireLasers: function() {
        this.fire('uvalib-catalog-lasers', {sound: 'Pew pew!'});
      }
    });
  })();
  </script>
</dom-module>
