<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../uvalib-api/uvalib-api.html">

<!--
Element providing an easy component access to the uva library's catalog.

##### Example

    <uvalib-catalog></uvalib-catalog>

@element uvalib-catalog
@blurb Element providing an easy component access to the uva library's catalog.
@status alpha
@homepage http://uvalib-components.github.io/uvalib-catalog
-->
<polymer-element name="uvalib-catalog" attributes="auto count facets items advanced availability directions facetlimits page per_page query sort_order">
  <template>
    <uvalib-api on-uvalib-api-load="{{apiLoaded}}"></uvalib-api>
  </template>
  <script>
    Polymer({

      observe: {
        auto: 'fetch',
        advanced: 'fetch',
        availability: 'fetch',
        directions: 'fetch',
        facetlimits: 'fetch',
        page: 'fetch',
        'per_page': 'fetch',
        query: 'fetch',
        'sort_order': 'fetch'
      },

      /**
       * The `auto` attribute set to true means that the catalog will be queried 
       * whenever a request attribute is changed.
       *
       * @attribute auto
       * @type bool
       * @default false
       */
      auto: false,

      /**
       * The `count` attribute is set to the total query result count from the 
       * catalog once a request has been fetched
       *
       * @attribute count
       * @type string
       * @default null
       */
      count: null,

      /**
       * The `facets` attribute is set with the facet counts for a catalog request
       *
       * @attribute facets
       * @type object
       * @default null
       */
      facets: null,

      /**
       * The `items` attribute is set with the results for a catalog request
       *
       * @attribute items
       * @type array
       * @default null
       */
      items: null,

      /**
       * The `query` attribute sets the general query of the catalog search request
       *
       * @attribute query
       * @type string
       * @default ""
       */
      query: "",

      /**
       * The `api` property is set to the Library's client catalog api once loaded
       *
       * @attribute api
       * @type object
       * @default null
       */
      api: null,

      apiLoaded: function (e) {
        this.api = e.detail.catalog;
        if (this.auto)
          this.fetch();
      },

      // Keep track of requests so that older ones can be ignored
      // ToDo: see if we can cancel api requests before they return
      requests:[],

      /**
       * The `fetch` method will make a query request against the catalog.
       *
       * @method fetch
       */
      fetch: function () {
        if (this.api) {

          // Cancel all requests currently running
          for (var i=0; i<this.requests.length; i++)
            this.requests[i].cancel=true;

          pack = {
            query: this.query
          };

          // Put a simple message into the requests queue for this request
          var mess = {cancel:false};
          this.requests.push(mess);

          this.api.search(pack).execute( this.parseResults.bind(this, mess) );
          console.log('fetching catalog results!');
        }
      },

      /**
       * The `uvalib-catalog-fetched-results` event is fired whenever we
       * call fetch and process the results.
       *
       * @event uvalib-catalog-fetched-results
       */
      parseResults: function(mess, results){
        if (!mess.cancel) {
          this.count = results.count;
          this.items = results.items;          
          this.facets = results.facets;
          this.fire('uvalib-catalog-fetched-results');
        } else {
          console.log('fetch canceled!');
        }

        // remove this requests message from the queue
        for (var i=0; i<this.requests.length; i++)
          if (mess == this.requests[i]) {
            this.requests.splice(i,1);
            break;
          }
      }
      
    });
  </script>
</polymer-element>
