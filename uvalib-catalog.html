<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../uvalib-api/uvalib-api.html">

<!--
Element providing an easy component access to the uva library's catalog.

##### Example

    <uvalib-catalog></uvalib-catalog>

@element uvalib-catalog
@blurb Element providing an easy component access to the uva library's catalog.
@status alpha
@homepage http://uvalib-components.github.io/uvalib-catalog
-->
<polymer-element name="uvalib-catalog" attributes="auto count facets items availability directions facetlimits page per_page query sort_order operator author title_query journal_title subject keywords call_number publisher year_published_start year_published_end">
  <template>
    <uvalib-api on-uvalib-api-load="{{apiLoaded}}"></uvalib-api>
  </template>
  <script>
    Polymer({

      observe: {
        auto: 'fetch',
        advanced: 'fetch',
        availability: 'fetch',
        directions: 'fetch',
        facetlimits: 'fetch',
        page: 'fetch',
        'per_page': 'fetch',
        query: 'fetch',
        'sort_order': 'fetch'
      },

      /**
       * The `auto` attribute set to true means that the catalog will be queried 
       * whenever a request attribute is changed.
       *
       * @attribute auto
       * @type bool
       * @default false
       */
      auto: false,

      /**
       * The `count` attribute is set to the total query result count from the 
       * catalog once a request has been fetched
       *
       * @attribute count
       * @type string
       * @default null
       */
      count: null,

      /**
       * The `facets` attribute is set with the facet counts for a catalog request
       *
       * @attribute facets
       * @type object
       * @default null
       */
      facets: null,

      /**
       * The `items` attribute is set with the results for a catalog request
       *
       * @attribute items
       * @type array
       * @default null
       */
      items: null,

      /**
       * The `availability` attribute specifies wheather the results should include availability info (at the cost of a slower response)
       *
       * @attribute availability
       * @type boolean
       * @default false
       */ 
      availability: false, 

      /**
       * The `directions` attribute specifies wheather the results should include directions info
       *
       * @attribute directions
       * @type boolean
       * @default false
       */ 
      directions: false, 

      //facetlimits 

      /**
       * The `page` attribute specifies the page of results to return from the catalog search
       *
       * @attribute page
       * @type integer
       * @default 1
       */ 
      page: 1, 

      /**
       * The `per_page` attribute limits the number of results returned in the catalog search result
       *
       * @attribute per_page
       * @type integer
       * @default 10
       */      
      'per_page': 10,

      /**
       * The `query` attribute sets the general query of the catalog search request
       *
       * @attribute query
       * @type string
       * @default ""
       */
      query: "",

      /**
       * The `sort_order` attribute sets the sort order of the catalog search results.
       * Values can be one of "author", "published", "published_a", "received", "relevancy", or "title"
       *
       * @attribute sort_order
       * @type string
       * @default "relevancy"
       */
      'sort_order': "relevancy",

      /**
       * The `operator` attribute sets the operator used for the advanced fields.  Options are 'AND' and 'OR'.
       *
       * @attribute query
       * @type string
       * @default "AND"
       */
      operator:'AND',

      /**
       * The `author` attribute sets the advanced query for author
       *
       * @attribute author
       * @type string
       * @default ""
       */
      author:'',

      /**
       * The `title` attribute sets the advanced query for title
       *
       * @attribute title
       * @type string
       * @default ""
       */
      'title_query':'',

      /**
       * The `journal_title` attribute sets the advanced query for journal_title
       *
       * @attribute journal_title
       * @type string
       * @default ""
       */
      'journal_title':'',

      /**
       * The `subject` attribute sets the advanced query for subject
       *
       * @attribute subject
       * @type string
       * @default ""
       */
      subject:'',

      /**
       * The `keywords` attribute sets the advanced query for keywords
       *
       * @attribute keywords
       * @type string
       * @default ""
       */
      keywords:'',

      /**
       * The `call_number` attribute sets the advanced query for call_number
       *
       * @attribute call_number
       * @type string
       * @default ""
       */
      'call_number':'',

      /**
       * The `publisher` attribute sets the advanced query for publisher
       *
       * @attribute publisher
       * @type string
       * @default ""
       */
      publisher:'',

      /**
       * The `year_published_start` attribute sets the advanced query for year_published_start
       *
       * @attribute year_published_start
       * @type string
       * @default ""
       */
      'year_published_start':'',

      /**
       * The `year_published_end` attribute sets the advanced query for year_published_end
       *
       * @attribute year_published_end
       * @type string
       * @default ""
       */
      'year_published_end':'',

      /**
       * The `api` property is set to the Library's client catalog api once loaded
       *
       * @attribute api
       * @type object
       * @default null
       */
      api: null,

      apiLoaded: function (e) {
        this.api = e.detail.catalog;
        if (this.auto)
          this.fetch();
      },

      // Keep track of requests so that older ones can be ignored
      // ToDo: see if we can cancel api requests before they return
      requests:[],

      /**
       * The `fetch` method will make a query request against the catalog.
       *
       * @method fetch
       */
      fetch: function () {
        if (this.api) {

          // Cancel all requests currently running
          for (var i=0; i<this.requests.length; i++)
            this.requests[i].cancel=true;

          pack = {
            availability: this.availability,
            page: this.page,
            'per_page': this['per_page'],
            query: this.query,
            'sort_order': this['sort_order'],
            operator: this.operator,
            author: this.author,
            title: this['title_query'],
            'journal_title': this['journal_title'],
            subject: this.subject,
            keywords: this.keywords,
            'call_number': this['call_number'],
            publisher: this.publisher,
            'year_published_start': this['year_published_start'],
            'year_published_end': this['year_published_end']
          };

          // Put a simple message into the requests queue for this request
          var mess = {cancel:false};
          this.requests.push(mess);

          this.api.search(pack).execute( this.parseResults.bind(this, mess) );
          console.log('fetching catalog results!');
        }
      },

      /**
       * The `uvalib-catalog-fetched-results` event is fired whenever we
       * call fetch and process the results.
       *
       * @event uvalib-catalog-fetched-results
       */
      parseResults: function(mess, results){
        if (!mess.cancel) {
          this.count = results.count;
          this.items = results.items;          
          this.facets = results.facets;
          this.fire('uvalib-catalog-fetched-results');
        } else {
          console.log('fetch canceled!');
        }

        // remove this requests message from the queue
        for (var i=0; i<this.requests.length; i++)
          if (mess == this.requests[i]) {
            this.requests.splice(i,1);
            break;
          }
      }
      
    });
  </script>
</polymer-element>
